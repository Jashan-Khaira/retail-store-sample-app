version: 0.2
phases:
  install:
    runtime-versions:
      java: corretto17
      nodejs: 18
    commands:
      - cd src/checkout
      - npm install
      - npm install eslint
      - npm install eslint-config-standard --save-dev
      - cd ../cart
      - wget https://github.com/checkstyle/checkstyle/releases/download/checkstyle-10.3.3/checkstyle-10.3.3-all.jar
  build:
    commands:
      # Run Java checkstyle and store output
      - echo "Running Checkstyle analysis..."
      - java -jar checkstyle-10.3.3-all.jar -c /google_checks.xml src/main/java/ > checkstyle-output.txt || export CHECKSTYLE_EXIT=$?
      - echo "Checkstyle exit code: $CHECKSTYLE_EXIT"
      
      # Run ESLint and store output
      - cd ../checkout
      - echo "Running ESLint analysis..."
      - ./node_modules/.bin/eslint . --format json > eslint-report.json || export ESLINT_EXIT=$?
      - echo "ESLint exit code: $ESLINT_EXIT"
      
      # Process results and notify if issues found
      - |
        if [ ! -z "$CHECKSTYLE_EXIT" ] && [ "$CHECKSTYLE_EXIT" -eq 2 ] || [ ! -z "$ESLINT_EXIT" ] && [ "$ESLINT_EXIT" -eq 2 ]; then
          echo "Critical issues found in static analysis"
          aws sns publish \
            --topic-arn arn:aws:sns:us-east-1:061039764011:retail-store-build-notifications \
            --message "Critical issues found in static code analysis. Check the CodeBuild logs for details." \
            --region us-east-1
          exit 1
        fi
  post_build:
    commands:
      - echo "Static analysis completed"
      - |
        if [ -s src/cart/checkstyle-output.txt ]; then
          echo "Checkstyle findings:"
          cat src/cart/checkstyle-output.txt
        fi
      - |
        if [ -s src/checkout/eslint-report.json ]; then
          echo "ESLint findings:"
          cat src/checkout/eslint-report.json
        fi
artifacts:
  files:
    - src/cart/checkstyle-output.txt
    - src/checkout/eslint-report.json
    - buildspec.yml
